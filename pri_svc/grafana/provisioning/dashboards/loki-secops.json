{
  "id": null,
  "uid": "loki-sec-essentials",
  "title": "SecOps Essentials (Personal)",
  "tags": ["loki", "secops", "essentials", "personal"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 2,
  "refresh": "5m",
  "time": { "from": "now-24h", "to": "now" },

  "templating": {
    "list": [
      {
        "name": "host",
        "label": "Host (Traefik)",
        "type": "query",
        "datasource": { "type": "loki", "uid": "loki" },
        "query": "label_values({service=\"traefik\", stream=\"access\"}, req_host)",
        "includeAll": true,
        "multi": true,
        "refresh": 1
      },
      {
        "name": "jail",
        "label": "Fail2ban Jail",
        "type": "query",
        "datasource": { "type": "loki", "uid": "loki" },
        "query": "label_values({service=\"fail2ban\", stream=\"main\"}, jail)",
        "includeAll": true,
        "multi": true,
        "refresh": 1
      }
    ]
  },

  "panels": [
    {
      "type": "stat",
      "title": "요청/초 (Traefik, 5m)",
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(rate({service=\"traefik\", stream=\"access\", req_host=~\"${host:regex}\"}[5m]))"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "fieldConfig": { "defaults": { "unit": "ops" } }
    },

    {
      "type": "stat",
      "title": "5xx 비율 (5m)",
      "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "100 * sum(rate({service=\"traefik\", stream=\"access\", status_class=\"500\", req_host=~\"${host:regex}\"}[5m])) / sum(rate({service=\"traefik\", stream=\"access\", req_host=~\"${host:regex}\"}[5m])) or on() vector(0)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green" },
              { "color": "orange", "value": 1 },
              { "color": "red", "value": 2 }
            ]
          }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "type": "stat",
      "title": "ModSecurity 이벤트 (1h)",
      "gridPos": { "x": 12, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(count_over_time({service=\"modsecurity\", stream=\"audit\", has_msg=\"1\"}[1h]))"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "type": "stat",
      "title": "Fail2ban Bans (1h)",
      "gridPos": { "x": 18, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(count_over_time({service=\"fail2ban\", stream=\"main\", action=\"ban\", jail=~\"${jail:regex}\"}[1h]))"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "type": "timeseries",
      "title": "Traefik 요청량 (lines/s) — by host",
      "gridPos": { "x": 0, "y": 4, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (req_host)(rate({service=\"traefik\", stream=\"access\", req_host=~\"${host:regex}\"}[5m]))"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    },

    {
      "type": "timeseries",
      "title": "Traefik 4xx/5xx (lines/s) — by host",
      "gridPos": { "x": 12, "y": 4, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (req_host, status_class)(rate({service=\"traefik\", stream=\"access\", status_class=~\"400|500\", req_host=~\"${host:regex}\"}[5m]))"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    },

    {
      "type": "table",
      "title": "Top 404 Paths (1h)",
      "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "topk(10, sum by (path) (count_over_time({service=\"traefik\", stream=\"access\", status=\"404\", req_host=~\"${host:regex}\"} | json | label_format path=\"{{.path}}\" [1h])))"
        }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": {} },
        {
          "id": "organize",
          "options": {
            "renameByName": { "Value #A": "Count", "path": "Path" },
            "excludeByName": { "Time": true }
          }
        },
        { "id": "sortBy", "options": { "sort": [ { "field": "Count", "desc": true } ] } }
      ],
      "options": { "showHeader": true }
    },

    {
      "type": "timeseries",
      "title": "Fail2ban — bans by jail (5m window)",
      "gridPos": { "x": 12, "y": 12, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (jail)(count_over_time({service=\"fail2ban\", stream=\"main\", action=\"ban\", jail=~\"${jail:regex}\"}[5m]))"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    },

    {
      "type": "table",
      "title": "Fail2ban — 최근 Ban (24h)",
      "gridPos": { "x": 0, "y": 20, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "queryType": "range",
          "expr": "{service=\"fail2ban\", stream=\"main\", action=~\"ban|unban\", jail=~\"${jail:regex}\", ip=~\".+\", ip!~\"^(a|unknown)$\"}"
        }
      ],
      "transformations": [
        { "id": "extractFields", "options": { "source": "labels" } },
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "labels": true,
              "Line": true,
              "tsNs": true,
              "labelTypes": true,
              "id": true,
              "component": true,
              "service": true,
              "service_name": true,
              "source": true,
              "stream": true
            },
            "indexByName": { "Time": 0, "ip": 1, "action": 2, "jail": 3, "level": 4 },
            "renameByName": { "ip": "IP", "action": "Action", "jail": "Jail", "level": "Level" }
          }
        },
        { "id": "sortBy", "options": { "sort": [ { "field": "Time", "desc": true } ] } }
      ],
      "options": { "showHeader": true }
    },

    {
      "type": "table",
      "title": "Fail2ban — Repeat Offenders (7d)",
      "gridPos": { "x": 12, "y": 20, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "topk(20, sum by (ip) (count_over_time({service=\"fail2ban\", stream=\"main\", action=\"ban\", jail=~\"${jail:regex}\"}[7d])))"
        }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": {} },
        {
          "id": "organize",
          "options": {
            "renameByName": { "Value #A": "Ban Count", "ip": "IP" },
            "excludeByName": { "Time": true }
          }
        },
        { "id": "sortBy", "options": { "sort": [ { "field": "Ban Count", "desc": true } ] } }
      ],
      "options": { "showHeader": true }
    },

    {
      "type": "timeseries",
      "title": "ModSecurity — Severity (5m 건수)",
      "gridPos": { "x": 0, "y": 28, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (severity_level)(count_over_time({service=\"modsecurity\", stream=\"audit\", has_msg=\"1\", severity_level!=\"NA\"}[5m]))"
        }
      ],
      "options": {
        "stacking": { "mode": "normal" },
        "legend": { "displayMode": "list", "placement": "right" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "fieldConfig": { "defaults": { "decimals": 0, "custom": { "axisSoftMin": 0 } } }
    },

    {
      "type": "table",
      "title": "ModSecurity — Top Attacks (24h)",
      "gridPos": { "x": 12, "y": 28, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "topk(10, sum by (rule, msg) (count_over_time({service=\"modsecurity\", stream=\"audit\", has_msg=\"1\"} | logfmt [24h])))"
        }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": {} },
        {
          "id": "organize",
          "options": {
            "renameByName": { "Value #A": "Count", "rule": "Rule ID", "msg": "Message" },
            "excludeByName": { "Time": true }
          }
        },
        { "id": "sortBy", "options": { "sort": [ { "field": "Count", "desc": true } ] } }
      ],
      "options": { "showHeader": true }
    },

    {
      "type": "logs",
      "title": "최근 ModSecurity 이벤트",
      "gridPos": { "x": 0, "y": 36, "w": 24, "h": 8 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        { "refId": "A", "expr": "{service=\"modsecurity\", stream=\"audit\"}" }
      ]
    }
  ]
}

