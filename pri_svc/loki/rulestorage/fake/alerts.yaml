groups:
- name: loki-secops
  interval: 1m
  rules:

  # === 운영 알림 ===
  - alert: High5xxRate
    expr: |
      sum(rate({service="traefik", stream="access", status_class="500"}[5m]))
        / sum(rate({service="traefik", stream="access"}[5m])) > 0.02
    for: 2m
    labels:
      severity: critical
      service: secops
    annotations:
      summary: "5xx 오류 비율이 2% 이상"
      description: "최근 5분간 5xx 비율이 급증 (서비스 오류 가능성)"

  - alert: TrafficDrop
    expr: |
      sum(rate({service="traefik", stream="access"}[5m])) < 1
    for: 3m
    labels:
      severity: warning
      service: secops
    annotations:
      summary: "요청 트래픽 급감"
      description: "Traefik 요청량이 비정상적으로 줄어듦 → 서비스 중단 가능성"

  # === 보안 알림 ===
  - alert: Fail2banBanTriggered
    expr: |
      sum(count_over_time({service="fail2ban", stream="main", action="ban"}[5m])) > 0
    for: 0m
    labels:
      severity: warning
      service: secops
    annotations:
      summary: "Fail2ban Ban 발생"
      description: "IP가 Fail2ban에 의해 차단됨 (최근 5분 이내)"

  - alert: RepeatOffender
    expr: |
      topk(1, sum by (ip) (count_over_time({service="fail2ban", stream="main", action="ban"}[1h]))) > 5
    for: 0m
    labels:
      severity: critical
      service: secops
    annotations:
      summary: "Fail2ban 반복 차단 IP"
      description: "동일 IP가 1시간 내 5회 이상 차단됨"

  - alert: ModSecurityCritical
    expr: |
      sum(rate({service="modsecurity", stream="audit", severity_level="CRITICAL"}[5m])) > 0
    for: 0m
    labels:
      severity: critical
      service: secops
    annotations:
      summary: "ModSecurity Critical 이벤트 발생"
      description: "웹 공격 (CRITICAL 레벨) 탐지됨"

  - alert: ModSecurityHigh
    expr: |
      sum(rate({service="modsecurity", stream="audit", severity_level="HIGH"}[5m])) > 2
    for: 5m
    labels:
      severity: warning
      service: secops
    annotations:
      summary: "ModSecurity High 이벤트 다수 발생"
      description: "최근 5분간 HIGH 레벨 이벤트 2건 이상"

  - alert: Top404Scanner
    expr: |
      topk(1, sum by (path) (count_over_time(({service="traefik", stream="access", status="404"} | json | label_format path="{{.path}}") [5m]))) > 50
    for: 2m
    labels:
      severity: warning
      service: secops
    annotations:
      summary: "404 다량 발생"
      description: "특정 Path에서 5분간 50회 이상 404 발생 → 스캐닝 의심"
