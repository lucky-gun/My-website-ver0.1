load_module modules/ngx_http_modsecurity_module.so;

user nginx;
worker_processes auto;

events { worker_connections 4096; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # ⛔ ModSecurity 전역 설정 금지 (서버블록/위치별로 제어)
  # Sec* 류 설정은 여기서 하지 않습니다.

  # 🔄 WebSocket 호환: 비-WS일 때 Connection 헤더 미전송
  map $http_upgrade $proxy_connection { default upgrade; '' ''; }

  # 🧭 X-Forwarded-Proto/Port 정합성 (Traefik/CF 연동)
  map $http_x_request_id $reqid { default $http_x_request_id; "" $request_id; }
  map $http_x_forwarded_proto $proxy_xfp { default $http_x_forwarded_proto; "" $scheme; }
  map $proxy_xfp $xfp_port { https 443; http 80; default 443; }

  # 🌐 공통 프록시 헤더
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Forwarded-Proto $proxy_xfp;
  proxy_set_header X-Forwarded-Port  $xfp_port;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header Upgrade           $http_upgrade;
  proxy_set_header Connection        $proxy_connection;
  proxy_set_header X-Request-ID      $reqid;

  # ⛔ 전역 금지(서비스별 위치에서만 세팅)
  # proxy_set_header OCS-APIRequest    "true";
  # proxy_set_header X-Requested-With  "XMLHttpRequest";

  # 📦 기본기
  server_tokens off;
  sendfile on;  tcp_nopush on;  tcp_nodelay on;
  keepalive_timeout 65; keepalive_requests 10000;

  # 🗜️  압축(텍스트만)
  gzip on; gzip_vary on;
  gzip_types text/plain text/css application/javascript application/json application/xml text/xml image/svg+xml;

  # [보안/하드닝] 슬로우로리스/유휴 커넥션 정리
  client_header_timeout 15s;
  client_body_timeout   60s;
  reset_timedout_connection on;

  # ⏱️ 타임아웃 (대용량 업/다운로드 고려)
  proxy_connect_timeout 30s;
  proxy_send_timeout    120s;
  proxy_read_timeout    120s;
  send_timeout          120s;

  proxy_hide_header Server;

  # 🔎 원격 IP (Cloudflare/도커 네트워크)
  real_ip_header CF-Connecting-IP;
  set_real_ip_from 172.20.0.0/24;
  set_real_ip_from 172.24.0.0/24;
  real_ip_recursive on;
  #proxy_set_header X-Edge-IP $realip_remote_addr;


  include /etc/nginx/conf.d/*.conf;
  error_log /var/log/nginx/error.log warn;
}
