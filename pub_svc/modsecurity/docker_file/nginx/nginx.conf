load_module modules/ngx_http_modsecurity_module.so;

user nginx;
worker_processes auto;

events { worker_connections 4096; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # â›” ModSecurity ì „ì—­ ì„¤ì • ê¸ˆì§€ (ì„œë²„ë¸”ë¡/ìœ„ì¹˜ë³„ë¡œ ì œì–´)
  # Sec* ë¥˜ ì„¤ì •ì€ ì—¬ê¸°ì„œ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

  # ğŸ”„ WebSocket í˜¸í™˜: ë¹„-WSì¼ ë•Œ Connection í—¤ë” ë¯¸ì „ì†¡
  map $http_upgrade $proxy_connection { default upgrade; '' ''; }

  # ğŸ§­ X-Forwarded-Proto/Port ì •í•©ì„± (Traefik/CF ì—°ë™)
  map $http_x_request_id $reqid { default $http_x_request_id; "" $request_id; }
  map $http_x_forwarded_proto $proxy_xfp { default $http_x_forwarded_proto; "" $scheme; }
  map $proxy_xfp $xfp_port { https 443; http 80; default 443; }

  # ğŸŒ ê³µí†µ í”„ë¡ì‹œ í—¤ë”
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Forwarded-Proto $proxy_xfp;
  proxy_set_header X-Forwarded-Port  $xfp_port;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header Upgrade           $http_upgrade;
  proxy_set_header Connection        $proxy_connection;
  proxy_set_header X-Request-ID      $reqid;

  # â›” ì „ì—­ ê¸ˆì§€(ì„œë¹„ìŠ¤ë³„ ìœ„ì¹˜ì—ì„œë§Œ ì„¸íŒ…)
  # proxy_set_header OCS-APIRequest    "true";
  # proxy_set_header X-Requested-With  "XMLHttpRequest";

  # ğŸ“¦ ê¸°ë³¸ê¸°
  server_tokens off;
  sendfile on;  tcp_nopush on;  tcp_nodelay on;
  keepalive_timeout 65; keepalive_requests 10000;

  # ğŸ—œï¸  ì••ì¶•(í…ìŠ¤íŠ¸ë§Œ)
  gzip on; gzip_vary on;
  gzip_types text/plain text/css application/javascript application/json application/xml text/xml image/svg+xml;

  # [ë³´ì•ˆ/í•˜ë“œë‹] ìŠ¬ë¡œìš°ë¡œë¦¬ìŠ¤/ìœ íœ´ ì»¤ë„¥ì…˜ ì •ë¦¬
  client_header_timeout 15s;
  client_body_timeout   60s;
  reset_timedout_connection on;

  # â±ï¸ íƒ€ì„ì•„ì›ƒ (ëŒ€ìš©ëŸ‰ ì—…/ë‹¤ìš´ë¡œë“œ ê³ ë ¤)
  proxy_connect_timeout 30s;
  proxy_send_timeout    120s;
  proxy_read_timeout    120s;
  send_timeout          120s;

  proxy_hide_header Server;

  # ğŸ” ì›ê²© IP (Cloudflare/ë„ì»¤ ë„¤íŠ¸ì›Œí¬)
  real_ip_header CF-Connecting-IP;
  set_real_ip_from 172.20.0.0/24;
  set_real_ip_from 172.24.0.0/24;
  real_ip_recursive on;
  #proxy_set_header X-Edge-IP $realip_remote_addr;


  include /etc/nginx/conf.d/*.conf;
  error_log /var/log/nginx/error.log warn;
}
