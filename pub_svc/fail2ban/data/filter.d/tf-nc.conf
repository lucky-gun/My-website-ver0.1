# /etc/fail2ban/filter.d/traefik-nextcloud.conf
[Definition]
#datepattern = "time":"{ISO8601}"
datepattern = ^.*"time":"{ISO8601}"
# OCS 로그인 실패(401) + DAV 401/403 반복을 포착
failregex =
    ^\{.*"(?:ClientHost|ClientAddr)"\s*:\s*"<HOST>".*(?=.*"RequestHost"\s*:\s*"cloud\.lucky-gun\.com")(?=.*"(?:RequestPath|Path)"\s*:\s*"/ocs/v2\.php/cloud/[^"]*")(?=.*"(?:DownstreamStatus|status)"\s*:\s*401).*$
    ^\{.*"(?:ClientHost|ClientAddr)"\s*:\s*"<HOST>".*(?=.*"RequestHost"\s*:\s*"cloud\.lucky-gun\.com")(?=.*"(?:RequestPath|Path)"\s*:\s*"/remote\.php/(?:dav|webdav|carddav|caldav)/[^"]*")(?=.*"RequestMethod"\s*:\s*"(?:PROPFIND|MKCOL|PUT|DELETE|MOVE|COPY|LOCK|UNLOCK)")(?=.*"(?:DownstreamStatus|status)"\s*:\s*(?:401|403)).*$

ignoreregex =
    ^\{.*"(?:RequestPath|Path)"\s*:\s*"/status\.php".*$
    ^\{.*"(?:RequestPath|Path)"\s*:\s*"/ocs/v2\.php/(?:cloud/capabilities|apps)".*$
    ^\{.*"(?:RequestPath|Path)"\s*:\s*"/(?:metrics|healthz)".*$
    ^\{.*"(?:RequestPath|Path)"\s*:\s*"/(?:index|ocm-provider|ocs-provider|robots)\.php".*$
    ^\{.*"(?:RequestPath|Path)"\s*:\s*"/\.well-known/(?:acme-challenge|carddav|caldav|webfinger)".*$
